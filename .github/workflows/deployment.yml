name: Full Stack Application Deployment Test

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  COMPOSE_PROJECT_NAME: myapp

jobs:
  deploy-and-test:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create .env file
      run: |
        echo "Current directory:"
        Get-Location
        
        "DB_HOST=${{ secrets.DB_HOST }}" | Out-File -FilePath .env -Encoding utf8
        "DB_PORT=${{ secrets.DB_PORT }}" | Out-File -FilePath .env -Encoding utf8 -Append
        "DB_NAME=${{ secrets.DB_NAME }}" | Out-File -FilePath .env -Encoding utf8 -Append
        "DB_USER=${{ secrets.DB_USER }}" | Out-File -FilePath .env -Encoding utf8 -Append
        "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" | Out-File -FilePath .env -Encoding utf8 -Append
        "APP_PORT=${{ secrets.APP_PORT }}" | Out-File -FilePath .env -Encoding utf8 -Append
        "APP_SECRET=${{ secrets.APP_SECRET }}" | Out-File -FilePath .env -Encoding utf8 -Append
        "API_KEY=${{ secrets.API_KEY }}" | Out-File -FilePath .env -Encoding utf8 -Append
        "COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }}" | Out-File -FilePath .env -Encoding utf8 -Append
        
        echo "Checking .env file:"
        Get-ChildItem .env
        echo "File content (masked):"
        Get-Content .env | ForEach-Object { $_ -replace '=.*', '=***' }
    - name: Deploy with Docker Compose
      run: |
        docker-compose down
        docker-compose up -d
        Start-Sleep -Seconds 30
        docker-compose ps
    - name: Check containers
      run: |
        $status = docker-compose ps --services --filter "status=running"
        if ($status.Count -gt 0) {
          "Containers are running: $status"
        } else {
          "No containers running"
          exit 1
        }
    - name: Test application and database
      run: |
        echo "Testing application and database connection..."
        try {
            $response = Invoke-WebRequest -Uri "http://localhost:8001/" -TimeoutSec 10
            echo "Application database connection working"
        } catch {
            echo "Application database connection failed"
            exit 1
        }
    - name: Test data consistency
      run: |
        echo "Testing data consistency..."
        try {
            $dbStatus = docker-compose ps db --format "json" | ConvertFrom-Json
            echo "Database container is running"
            
            $webResponse = Invoke-WebRequest -Uri "http://localhost:${{ secrets.APP_PORT }}/" -TimeoutSec 10
            echo "Web application is running"
            
            echo "Data consistency test passed - both services are operational"
        } catch {
            echo "Data consistency test failed"
            exit 1
        }
    - name: Save artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-files
        path: |
          C:\Users\alber\_work\practice3\practice3\.env
          test-report.md
        retention-days: 30

    - name: Save logs
      run: |
        docker-compose logs > logs.txt
        docker ps -a > containers.txt
        docker images > images.txt
    - name: Create test report
      run: |
        "# Test Report" | Out-File test-report.md
        "- Date: $(Get-Date)" | Out-File test-report.md -Append
        "- Status: Success" | Out-File test-report.md -Append
    - name: Upload logs
      uses: actions/upload-artifact@v4
      with:
        name: docker-logs
        path: |
          logs.txt
          containers.txt
        retention-days: 30
