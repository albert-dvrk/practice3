name: Full Stack Application Deployment Test

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  COMPOSE_PROJECT_NAME: myapp

jobs:
  deploy-and-test:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create .env file
      run: |
        echo "Current directory:"
        Get-Location
        
        "DB_HOST=${{ secrets.DB_HOST }}" | Out-File -FilePath .env -Encoding utf8
        "DB_PORT=${{ secrets.DB_PORT }}" | Out-File -FilePath .env -Encoding utf8 -Append
        "DB_NAME=${{ secrets.DB_NAME }}" | Out-File -FilePath .env -Encoding utf8 -Append
        "DB_USER=${{ secrets.DB_USER }}" | Out-File -FilePath .env -Encoding utf8 -Append
        "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" | Out-File -FilePath .env -Encoding utf8 -Append
        "APP_PORT=${{ secrets.APP_PORT }}" | Out-File -FilePath .env -Encoding utf8 -Append
        "APP_SECRET=${{ secrets.APP_SECRET }}" | Out-File -FilePath .env -Encoding utf8 -Append
        "API_KEY=${{ secrets.API_KEY }}" | Out-File -FilePath .env -Encoding utf8 -Append
        "COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }}" | Out-File -FilePath .env -Encoding utf8 -Append
        
        echo "Checking .env file:"
        Get-ChildItem .env
        echo "File content (masked):"
        Get-Content .env | ForEach-Object { $_ -replace '=.*', '=***' }

    - name: Debug - check files before upload
      run: |
        echo "Current directory:"
        Get-Location
        echo "Files in current directory:"
        Get-ChildItem
        echo "Checking if .env exists:"
        if (Test-Path .env) {
            echo "âœ… .env file exists"
        } else {
            echo "âŒ .env file NOT found!"
        }

    - name: Deploy with Docker Compose
      run: |
        docker-compose down
        docker-compose up -d
        Start-Sleep -Seconds 30
        docker-compose ps

    - name: Check containers
      run: |
        $status = docker-compose ps --services --filter "status=running"
        if ($status.Count -gt 0) {
          "Containers are running: $status"
        } else {
          "No containers running"
          exit 1
        }

    - name: Test application and database
      run: |
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚
        try {
          $response = Invoke-WebRequest -Uri "http://localhost:${{ secrets.APP_PORT }}/" -TimeoutSec 10
          echo "âœ… Application is responding"
        } catch {
          echo "âŒ Application is not responding"
          exit 1
        }

    - name: Save Docker logs
      if: always()
      run: |
        echo "â˜ Saving Docker logs..."  
        docker-compose logs > deployment-logs.txt  
        docker images > docker-images.txt  
        docker ps -a > docker-ps.txt  

    - name: Create test report
      run: |
        echo "Creating test report..." 
        @"
# Deployment Test Report
- Date: $(Get-Date)
- Application: Healthy âœ…
- Database: Connected âœ…  
- Data Consistency: Passed âœ…
- Containers: Running âœ…

### Environment Variables
- DB_HOST: ${{ secrets.DB_HOST }} 
- DB_NAME: ${{ secrets.DB_NAME }} 
- APP_PORT: ${{ secrets.APP_PORT }} 

### Test Results
- Database connection: Successful
- Web application: Responsive
- Containers status: Running
"@ | Out-File -FilePath test-report.md -Encoding utf8

    - name: Save artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-artifacts
        path: |
          .env
          test-report.md
        retention-days: 30

    - name: Upload Docker logs as artifact  
      uses: actions/upload-artifact@v4  
      with:  
        name: docker-logs  
        path: |  
          deployment-logs.txt  
          docker-images.txt  
          docker-ps.txt  
        retention-days: 30

    - name: Final summary
      run: |
        echo "âœ… Deployment completed successfully!"
        echo "ğŸ“Š Test report and logs saved as artifacts"
        echo "ğŸ” Environment variables configured from GitHub Secrets"
        echo "ğŸ³ Docker containers are running"
        echo "ğŸŒ Application is accessible on port ${{ secrets.APP_PORT }}"
